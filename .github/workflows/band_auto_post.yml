name: Band Auto Posting

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Git setup
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global --add safe.directory '*'
        git checkout -b main || git checkout main
        
    - name: Setup Chrome and profile
      run: |
        if [ ! -d "chrome_profile" ]; then
          echo "::error::chrome_profile í´ë”ê°€ í•„ìš”í•©ë‹ˆë‹¤!"
          exit 1
        fi
        echo "Chrome profile í™•ì¸:"
        ls -la chrome_profile/
        
        # í”„ë¡œí•„ ê¶Œí•œ ì„¤ì •
        chmod -R 777 chrome_profile
        
        # Default í´ë” í™•ì¸
        if [ ! -d "chrome_profile/Default" ]; then
          echo "::error::ì˜¬ë°”ë¥¸ í¬ë¡¬ í”„ë¡œí•„ì´ ì•„ë‹™ë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… ìœ íš¨í•œ í¬ë¡¬ í”„ë¡œí•„ ë°œê²¬"

    - name: Check authentication data
      run: |
        if [ ! -d "chrome_profile" ]; then
          echo "::error::Chrome í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        else
          echo "âœ… ë¡œì»¬ Chrome í”„ë¡œí•„ ì‚¬ìš©"
          echo "í”„ë¡œí•„ ê²½ë¡œ: $(pwd)/chrome_profile"
          echo "í”„ë¡œí•„ ë‚´ìš©:"
          ls -la chrome_profile/
        fi
        
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
        
    - name: Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add - 
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        sudo apt-get update
        sudo apt-get install google-chrome-stable xvfb
        
    - name: Install dependencies
      run: |
        pip install selenium requests beautifulsoup4 webdriver_manager PyGithub

    - name: Update submodules
      run: |
        git submodule update --init --recursive
        git submodule foreach git pull origin main

    - name: Create config file
      env:
        EMAIL: ${{ secrets.EMAIL }}
        PASSWORD: ${{ secrets.PASSWORD }}
        POST_URL: ${{ secrets.URL }}
        TITLE: ${{ secrets.TITLE }}
        POST_TIME: ${{ secrets.TIME }}
        INTERVAL: ${{ secrets.INTERVAL }}
      run: |
        cat > config.json << EOL
        {
          "email": "$EMAIL",
          "password": "$PASSWORD",
          "post_url": "$POST_URL",
          "title": "$TITLE",
          "post_time": "$POST_TIME",
          "interval_hours": $INTERVAL,
          "bands": []
        }
        EOL
        cat config.json

    - name: Download saved cookies
      uses: actions/download-artifact@v4
      with:
        name: band-cookies
        path: .
      continue-on-error: true

    - name: Check cookie file
      run: |
        if [ ! -f "band_cookies.json" ]; then
          echo "::error::ì¿ í‚¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œì»¬ì—ì„œ band_auto_poster.pyë¥¼ ì‹¤í–‰í•˜ì—¬ ì¿ í‚¤ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."
          exit 1
        fi

    - name: Load band URLs
      run: |
        if [ -f "band_urls.json" ]; then
          echo "Found saved band URLs"
          cat band_urls.json
        else
          echo "No saved band URLs found"
        fi

    - name: Setup authentication data
      run: |
        # Chrome í”„ë¡œí•„ ë° ì¿ í‚¤ ì„¤ì •
        mkdir -p chrome_profile
        if [ -f "band_cookies.json" ]; then
          echo "Found cookies file"
        fi
        if [ -d "chrome_profile" ]; then
          echo "Found Chrome profile"
          chmod -R 777 chrome_profile
        fi
        
        # band_urls.json í™•ì¸
        if [ -f "band_urls.json" ]; then
          echo "Found band URLs:"
          cat band_urls.json
        else
          echo "No band URLs found"
        fi

    - name: Install VPN dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shadowsocks-libev

    - name: Setup VPN configuration
      run: |
        # Create shadowsocks config file
        cat > vpn_config.json << EOF
        {
            "server":"34.64.189.76",
            "server_port":16978,
            "local_address":"127.0.0.1",
            "local_port":1080,
            "password":"Nsy5l8wxxzHg4CXPKwEw6S",
            "timeout":300,
            "method":"chacha20-ietf-poly1305"
        }
        EOF
        
        # Create VPN control script
        cat > vpn.sh << 'EOF'
        #!/bin/bash
        
        start_vpn() {
          ss-local -c vpn_config.json -v &
          sleep 5
          echo "VPN started"
        }
        
        stop_vpn() {
          pkill ss-local
          echo "VPN stopped"
        }
        
        case "$1" in
          start)
            start_vpn
            ;;
          stop)
            stop_vpn
            ;;
          *)
            echo "Usage: $0 {start|stop}"
            exit 1
        esac
        EOF
        
        chmod +x vpn.sh

    - name: Connect to VPN
      run: |
        ./vpn.sh start
        curl -x socks5h://127.0.0.1:1080 ifconfig.me
        echo "VPN ì—°ê²°ë¨ - í˜„ìž¬ IP í™•ì¸"

    - name: Run band poster with auth data
      run: |
        # í¬ë¡¬ í”„ë¡œí•„ ìž¬í™•ì¸
        if [ ! -d "chrome_profile" ]; then
          echo "::error::chrome_profile í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "ðŸ” í¬ë¡¬ í”„ë¡œí•„ ìƒíƒœ:"
        ls -la chrome_profile/
        
        # í”„ë¡œí•„ ê¶Œí•œ í•œë²ˆ ë” í™•ì¸
        chmod -R 777 chrome_profile
        
        # ì‹¤í–‰
        xvfb-run --server-args="-screen 0 1920x1080x24" \
          --auto-servernum \
          python run_band_poster.py

    - name: Disconnect VPN
      if: always()
      run: |
        ./vpn.sh stop
        echo "VPN ì—°ê²° í•´ì œë¨"

    - name: Save updated auth data
      if: success()
      run: |
        if [ -f "band_cookies.json" ]; then
          cp band_cookies.json band_cookies.json.new
        fi
        if [ -d "chrome_profile" ]; then
          cp -r chrome_profile chrome_profile.new
        fi

    - name: Upload auth data
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: auth-data
        path: |
          band_cookies.json.new
          chrome_profile.new/
        retention-days: 7
        
    - name: Save profile and cookies
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: chrome-data
        path: |
          chrome_profile/
          band_cookies.json
        retention-days: 7
        
    - name: Save cookies
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: band-cookies
        path: band_cookies.json
        retention-days: 30
        
    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd $GITHUB_WORKSPACE
        git add -A
        git status
        if ! git diff --quiet HEAD; then
          git commit -m "Update chrome profile [skip ci]"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:main -f
        else
          echo "No changes to commit"
        fi
